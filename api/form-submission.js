// Form submission API - sends email notification
export default async function handler(req, res) {
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    try {
        const formData = req.body;

        // Build email content
        const statusLabels = {
            'qualified': '‚úÖ QUALIFIED - New User Signup',
            'waitlisted': 'üìã WAITLISTED - Coaching Interest',
            'disqualified': '‚ùå DISQUALIFIED - Not a Creator'
        };

        const subject = statusLabels[formData.status] || 'New Form Submission';

        const emailBody = `
New Synoxus Form Submission
===========================

Status: ${formData.status?.toUpperCase() || 'Unknown'}
Submitted: ${formData.submittedAt || new Date().toISOString()}

CONTACT INFO
------------
Email: ${formData.email || 'Not provided'}
Display Name: ${formData.displayName || 'Not provided'}

SOCIAL ACCOUNTS
---------------
YouTube Channel: ${formData.youtubeChannel || 'None'}
Instagram: ${formData.instagramHandle ? '@' + formData.instagramHandle : 'None'}

PROFILE
-------
Has YouTube: ${formData.hasYouTube === true ? 'Yes' : formData.hasYouTube === false ? 'No' : 'Not answered'}
Business Type: ${formData.businessType || 'Not selected'}
Primary Goal: ${formData.primaryGoal || 'Not selected'}
Audience Size: ${formData.audienceSize || 'Not selected'}
Monthly Revenue: ${formData.monthlyRevenue || 'Not selected'}
Interested in Free Audit: ${formData.interestedInAudit === true ? 'Yes' : formData.interestedInAudit === false ? 'No' : 'Not answered'}

${formData.interestedInCoaching ? `
COACHING DETAILS
----------------
Interested in Coaching: Yes
Details: ${formData.coachingDetails || 'None provided'}
` : ''}

---
This email was automatically generated by Synoxus.
        `.trim();

        // Send email using Resend (if configured) or log for now
        const RESEND_API_KEY = process.env.RESEND_API_KEY;

        if (RESEND_API_KEY) {
            const response = await fetch('https://api.resend.com/emails', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${RESEND_API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    from: 'Synoxus <notifications@synoxus.com>',
                    to: 'iyohanthomas7@gmail.com',
                    subject: subject,
                    text: emailBody
                })
            });

            if (!response.ok) {
                console.error('Resend API error:', await response.text());
            }
        } else {
            // Fallback: Log to console (visible in Vercel logs)
            console.log('=== FORM SUBMISSION EMAIL ===');
            console.log('To: iyohanthomas7@gmail.com');
            console.log('Subject:', subject);
            console.log('Body:', emailBody);
            console.log('=============================');

            // Also try to save to Supabase for backup
            const { createClient } = await import('@supabase/supabase-js');
            const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
            const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

            if (supabaseUrl && supabaseKey) {
                const supabase = createClient(supabaseUrl, supabaseKey);
                await supabase.from('form_submissions').insert({
                    email: formData.email,
                    status: formData.status,
                    data: formData,
                    created_at: new Date().toISOString()
                }).catch(err => console.log('Supabase backup failed:', err.message));
            }
        }

        return res.status(200).json({ success: true });
    } catch (error) {
        console.error('Form submission error:', error);
        return res.status(500).json({ error: error.message });
    }
}

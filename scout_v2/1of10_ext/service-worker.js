const apiRoot="https://1of10.com/api";let controller=new AbortController;async function verifySession(){const e=await chrome.storage.local.get();if(e.lastSessionCheck&&"boolean"==typeof e.planActive&&Date.now()-e.lastSessionCheck<3e5)return!0;try{const e=await fetch(`${apiRoot}/users/me/`,{method:"GET",credentials:"include"}),t=await e.json();if(200===e.status)return await chrome.storage.local.set({lastSessionCheck:Date.now(),username:t.username,planActive:1===t.active,loggedIn:!0}),!0;throw new Error("No data")}catch{await chrome.storage.local.set({lastSessionCheck:0,username:null,planActive:!1,loggedIn:!1})}return!1}const filterNonNull=e=>Object.fromEntries(Object.entries(e).filter((([e,t])=>null!=t&&""!=t))),getQueryParamsStr=e=>`${new URLSearchParams(filterNonNull(e)).toString()}`;async function logout(){return 200===(await fetch(`${apiRoot}/logout`,{method:"POST",credentials:"include"})).status&&(await chrome.storage.local.clear(),!0)}async function getBookmarkFolders(e,t){const a=await fetch(`${apiRoot}/extension/folders?page_id=${e||0}&content_type=${t}`,{method:"GET",credentials:"include"});if(200===a.status){const e=await a.json();return[e.folders,e.next_page_id]}return[[],0]}async function getVideoFolder(e){const t=await fetch(`${apiRoot}/extension/videos/${e}/folders`,{method:"GET",credentials:"include"});return 200===t.status?await t.json():[]}async function createBookmarkFolder(e,t){return 200===(await fetch(`${apiRoot}/extension/folders?folder_name=${e}&content_type=${t}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}})).status}async function saveToBookmarkFolder(e,t,a){const n=await fetch(`${apiRoot}/extension/folders/${e}/videos?content_type=${a}`,{method:"POST",credentials:"include",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});return!![200,409].includes(n.status)}async function removeFromBookmarkFolder(e,t){const a=await fetch(`${apiRoot}/extension/folders/${e}/videos/${t}`,{method:"DELETE",credentials:"include"});return!![200,404].includes(a.status)}async function getTrackerFolders(e){const t=await fetch(`${apiRoot}/trackers/?page_id=${e||0}`,{method:"GET",credentials:"include"});if(200===t.status){const e=await t.json();return[e.tracking_folders,e.next_page_id]}return[[],0]}async function getChannelTrackers(e){const t=await fetch(`${apiRoot}/channels/tracking_folders?channel_name=${e}`,{method:"GET",credentials:"include"});return 200===t.status?(await t.json()).tracking_folders:[]}async function createTrackerFolder(e){return 200===(await fetch(`${apiRoot}/trackers/?folder_name=${e}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}})).status}async function saveToTrackerFolder(e,t){const a=await fetch(`${apiRoot}/trackers/${e}/?channel_name=${t}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});return!![200,400].includes(a.status)}async function removeFromTrackerFolder(e,t){const a=await fetch(`${apiRoot}/trackers/${e}/channels/?channel_name=${t}`,{method:"DELETE",credentials:"include"});return!![200,404].includes(a.status)}async function remixVideo(e,t,a,n,o,i){const s=await fetch(`${apiRoot}/remix/videos/extension?managed_channel_id=${o}&content_type=${n?"short":"long"}&yt_video_id=${e}&video_title=${a}&thumbnail_url=${t}&page=${i||0}`,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}});return 200===s.status?await s.json():{}}async function getRemixVideo(e){const t=await fetch(`${apiRoot}/remix/${e}`,{method:"GET",credentials:"include"});return 200===t.status?await t.json():{}}async function getSimilarThumbnails(e,t,a,n){n||(n={}),n.views_min||(n.views_min=5e3),n.published_at||(n.published_at="2_years");const o=await fetch(`${apiRoot}/extension/thumbnails/similar?yt_id=${e}&content_type=${t?"short":"long"}&page=${a||0}&${getQueryParamsStr(n)}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});return 200===o.status?await o.json():null}async function getSimilarVideos(e,t,a,n){n||(n={}),n.views_min||(n.views_min=5e3),n.published_at||(n.published_at="2_years");const o=await fetch(`${apiRoot}/videos/search?txt_input=${e}&content_type=${t?"short":"long"}&page_id=${a||0}&${getQueryParamsStr(n)}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});return 200===o.status?await o.json():null}async function getSimilarChannels(e,t){const a=await fetch(`${apiRoot}/extension/channels/similar/${e}?page_id=${t||0}`,{method:"GET",credentials:"include",headers:{"Content-Type":"application/json"}});return 200===a.status?await a.json():null}async function getVideoData(e){const t=await fetch(`${apiRoot}/videos/${e}`,{signal:controller.signal,credentials:"include",headers:{"Content-Type":"application/json"}});return 200===t.status?await t.json():{}}async function getManagedChannels(){const e=await fetch(`${apiRoot}/managed_channels/`,{credentials:"include",headers:{"Content-Type":"application/json"}});return 200===e.status?(await e.json()).managed_channels.filter((e=>"active"==e.channel_status)):[]}function asyncMessageResponder(e){return(t,a,n)=>(Promise.resolve(e(t,a)).then((e=>n(e)),(e=>{console.log(e),n({error:{message:e.message}})})),!0)}async function init(){const e=await chrome.storage.local.get();void 0===e.videoScoring&&await chrome.storage.local.set({videoScoring:!0}),void 0===e.videoSearch&&await chrome.storage.local.set({videoSearch:!0})}chrome.runtime.onMessage.addListener(asyncMessageResponder((async(e,t,a)=>{let n=null;if(t.tab&&e.action)switch(e.action){case"verifySession":n=await verifySession();break;case"logout":n=await logout();break;case"getFolders":n="bookmark"===e.type?await getBookmarkFolders(e.nextPageId,e.folderType):await getTrackerFolders(e.nextPageId);break;case"getVideoFolders":n=await getVideoFolder(e.videoId);break;case"getChannelTrackers":n=await getChannelTrackers(e.channelName);break;case"saveToFolder":n="bookmark"===e.type?await saveToBookmarkFolder(e.folderId,e.target,e.folderType):await saveToTrackerFolder(e.folderId,e.target);break;case"removeFromFolder":n="bookmark"===e.type?await removeFromBookmarkFolder(e.folderId,e.target):await removeFromTrackerFolder(e.folderId,e.target);break;case"createFolder":n="bookmark"===e.type?await createBookmarkFolder(e.folderName,e.folderType):await createTrackerFolder(e.folderName);break;case"getVideoData":n={};break;case"getManagedChannels":n=await getManagedChannels();break;case"remixVideo":n=await remixVideo(e.videoYoutubeId,e.videoThumbnail,e.videoTitle,e.isShort,e.managedChannelId,e.page);break;case"getRemixVideo":n=await getRemixVideo(e.remixId);break;case"similarThumbnails":n=await getSimilarThumbnails(e.videoId,e.isShort,e.page,e.filters);break;case"similarVideos":n=await getSimilarVideos(e.videoTitle,e.isShort,e.page,e.filters);break;case"similarChannels":n=await getSimilarChannels(e.videoTitle,e.page)}return n}))),init();
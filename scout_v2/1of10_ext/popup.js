const channelNameInputElem=document.getElementById("channel-name-input"),thumbnailInputElem=document.getElementById("thumbnail-input"),titleInputElem=document.getElementById("title-input"),logoutButton=document.getElementById("logout"),randomPlacementElem=document.getElementById("random-placement-checkbox");let thumbnailB64=null,channelName=null,videoTitle=null,randomPlacement=!1,loadedContentScript=!1;async function sendMessage(e){let[t]=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});return await chrome.tabs.sendMessage(t.id,e)}async function getUserData(){const e=await chrome.storage.local.get();e?.loggedIn?(document.getElementById("username").innerText=e.username,document.getElementById("plan").innerText=e.planActive?"Premium plan":"Free plan",document.getElementById("login").style.display="none"):(document.getElementById("user-header-container").style.display="none",document.getElementById("login").style.display="inline-flex")}function errorAlert(e){const t=document.createElement("div");t.classList.add("alert"),t.classList.add("error");const n=document.createElement("span");n.classList.add("alertText"),n.textContent=e,t.appendChild(n);const a=document.createElement("div"),l=document.createElement("input");l.type="checkbox",l.classList.add("alertCheckbox"),l.autocomplete="off",a.appendChild(l),a.appendChild(t),document.getElementById("alert-stack").appendChild(a),t.addEventListener("click",(e=>{a.remove()}))}function persist(e,t){let n={};n[e]=t,chrome.storage.local.set(n)}function handleChannelNameChange(e){channelName=e.target.value,persist("channelName",channelName)}function handleThumbnailChange(e){const t=e.target.files[0];if(t){const n=new FileReader;n.addEventListener("load",(()=>{thumbnailB64=n.result,persist("thumbnailB64",thumbnailB64);let t=document.createElement("img");t.src=thumbnailB64,t.id="preview",e.target.label.replaceChildren(t)}),!1),n.readAsDataURL(t)}}function handleTitleChange(e){videoTitle=e.target.value,persist("videoTitle",videoTitle)}function handleRandomPlacementChange(e){randomPlacement=e.target.checked,persist("randomPlacement",randomPlacement)}function handlePreviewClick(e){loadedContentScript?sendMessage({action:"preview",thumbnailB64,title:videoTitle,channelName,channelAvatar:null,randomPlacement}).catch((e=>{errorAlert("Please refresh the page to load all scripts."),console.log(e)})):errorAlert("Please refresh the page to load all scripts.")}function handleScoringEnabledChange(e){persist("videoScoring",e.target.checked)}function loadThumbnail(e){thumbnailB64=e,fetch(thumbnailB64).then((e=>e.blob())).then((e=>{const t=new File([e],"Thumbnail.png",{type:"image/jpeg"}),n=new DataTransfer;n.items.add(t),thumbnailInputElem.files=n.files,thumbnailInputElem.dispatchEvent(new Event("change"))}))}function loadVideoTitle(e){videoTitle=e,titleInputElem.value=videoTitle,titleInputElem.dispatchEvent(new Event("focus")),titleInputElem.dispatchEvent(new Event("change")),titleInputElem.dispatchEvent(new Event("blur"))}function loadChannelName(e){channelName=e,channelNameInputElem.value=channelName,channelNameInputElem.dispatchEvent(new Event("focus")),channelNameInputElem.dispatchEvent(new Event("change")),channelNameInputElem.dispatchEvent(new Event("blur"))}function loadRandomPlacement(e){randomPlacement=e,randomPlacementElem.checked=e,randomPlacementElem.dispatchEvent(new Event("click"))}async function checkForPersistentData(e){const t=await chrome.storage.local.get();t.thumbnailB64&&loadThumbnail(t.thumbnailB64),t.videoTitle&&loadVideoTitle(t.videoTitle),t.channelName&&loadChannelName(t.channelName),t.randomPlacement&&loadRandomPlacement(t.randomPlacement)}channelNameInputElem.addEventListener("change",handleChannelNameChange),thumbnailInputElem.addEventListener("change",handleThumbnailChange),titleInputElem.addEventListener("change",handleTitleChange),randomPlacementElem.addEventListener("click",handleRandomPlacementChange),logoutButton.addEventListener("click",(async()=>{await chrome.runtime.sendMessage({action:"logout"})&&closePopup()})),document.getElementById("preview-btn").addEventListener("click",handlePreviewClick);const labels=document.getElementsByTagName("LABEL");for(let e=0;e<labels.length;e++)if(""!=labels[e].htmlFor){let t=document.getElementById(labels[e].htmlFor);t&&(t.label=labels[e])}const textInputs=document.querySelectorAll("input[type=text]"),numberInputs=document.querySelectorAll("input[type=number]");let allInputs=[...textInputs,...numberInputs];for(const e of allInputs)e.addEventListener("focus",(e=>{e.target.label.classList.add("active"),e.target.label.classList.add("focused")})),e.addEventListener("blur",(e=>{e.target.value.toString().length<1&&e.target.label.classList.remove("active"),e.target.label.classList.remove("focused")}));async function closePopup(){parent.window.postMessage("removePopup","*")}async function checkIfLoggedIn(){chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&e.loggedIn&&getUserData()}))}async function init(){checkForPersistentData(),checkIfLoggedIn(),"pong"===await sendMessage({action:"ping"}).catch((e=>{errorAlert("Please refresh the page to load all scripts."),console.log(e)}))&&(loadedContentScript=!0,getUserData())}init();